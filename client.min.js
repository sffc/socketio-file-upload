/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2015 Shane Carr and others
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */

(function(h,d,f){"function"===typeof define&&define.amd?define(d,f):h[d]=f()})(this,"SocketIOFileUpload",function(){return function(h){var d=this;if(!window.File||!window.FileReader)throw Error("Socket.IO File Upload: Browser Not Supported");var f={},p=[],u=[];d.fileInputElementId="siofu_input";d.useText=!1;d.serializedOctets=!1;d.useBuffer=!0;d.chunkSize=102400;var q=function(a,b){var c=document.createEvent("Event");c.initEvent(a,!1,!1);for(var x in b)b.hasOwnProperty(x)&&(c[x]=b[x]);return d.dispatchEvent(c)},
n=[],e=function(a,b,c,d){a.addEventListener(b,c,d);n.push(arguments)},r=function(a,b,c,d){a.removeEventListener&&a.removeEventListener(b,c,d)},y=function(){for(var a=n.length-1;0<=a;a--)r.apply(this,n[a]);n=[]},z=function(a){if(null!==d.maxFileSize&&a.size>d.maxFileSize)q("error",{file:a,message:"Attempt by client to upload file exceeding the maximum file size",code:1});else if(q("start",{file:a})){var b=new FileReader,c=p.length,f=d.useText,t=0,n;p.push(a);var v=d.chunkSize;if(v>=a.size||0>=v)v=
a.size;var w=function(){var c=a.slice(t,Math.min(t+v,a.size));f?b.readAsText(c):b.readAsArrayBuffer(c)},l=function(e){var l=Math.min(t+v,a.size);a:{var p=t;e=e.target.result;var u=!1;if(!f)try{var m=new Uint8Array(e);if(d.serializedOctets)e=m;else if(d.useBuffer)e=m.buffer;else{var u=!0,k,r=m.buffer.byteLength,g="";for(k=0;k<r;k+=3)g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[m[k]>>2],g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(m[k]&3)<<4|m[k+1]>>
4],g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(m[k+1]&15)<<2|m[k+2]>>6],g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[m[k+2]&63];2===r%3?g=g.substring(0,g.length-1)+"=":1===r%3&&(g=g.substring(0,g.length-2)+"==");e=g}}catch(y){h.emit("siofu_done",{id:c,interrupt:!0});break a}h.emit("siofu_progress",{id:c,size:a.size,start:p,end:l,content:e,base64:u})}q("progress",{file:a,bytesLoaded:l,name:n});t+=v;t<a.size?w():(h.emit("siofu_done",{id:c}),q("load",
{file:a,reader:b,name:n}))};e(b,"load",l);e(b,"error",function(){h.emit("siofu_done",{id:c,interrupt:!0});r(b,"load",l)});e(b,"abort",function(){h.emit("siofu_done",{id:c,interrupt:!0});r(b,"load",l)});h.emit("siofu_start",{name:a.name,mtime:a.lastModifiedDate,meta:a.meta,size:a.size,encoding:f?"text":"octet",id:c});u.push(function(a){n=a;w()})}},w=function(a){if(0!==a.length){for(var b=0;b<a.length;b++)a[b].meta||(a[b].meta={});if(q("choose",{files:a}))for(b=0;b<a.length;b++)z(a[b])}},l=function(a){var b=
a.target.files||a.dataTransfer.files;a.preventDefault();w(b)};this.submitFiles=function(a){a&&w(a)};this.listenOnSubmit=function(a,b){b.files&&e(a,"click",function(){w(b.files)},!1)};this.listenOnArraySubmit=function(a,b){for(var c in b)this.listenOnSubmit(a,b[c])};this.listenOnInput=function(a){a.files&&e(a,"change",l,!1)};this.listenOnDrop=function(a){e(a,"dragover",function(a){a.preventDefault()},!1);e(a,"drop",l)};this.prompt=function(){var a;a=document.getElementById(d.fileInputElementId);a||
(a=document.createElement("input"),a.setAttribute("type","file"),a.setAttribute("id",d.fileInputElementId),a.style.display="none",document.body.appendChild(a));e(a,"change",l,!1);var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);a.dispatchEvent(b)};this.destroy=function(){y();var a=document.getElementById(d.fileInputElementId);a&&a.parentNode.removeChild(a);f={};p=[];u=[]};this.addEventListener=function(a,b){f[a]||(f[a]=[]);f[a].push(b)};
this.removeEventListener=function(a,b){if(!f[a])return!1;for(var c=0;c<f[a].length;c++)if(f[a][c]===b)return f[a].splice(c,1),!0;return!1};this.dispatchEvent=function(a){var b=f[a.type];if(!b)return!0;for(var c=!0,d=0;d<b.length;d++)!1===b[d](a)&&(c=!1);return c};e(h,"siofu_ready",function(a){u[a.id](a.name)});e(h,"siofu_complete",function(a){q("complete",{file:p[a.id],detail:a.detail,success:a.success})});e(h,"siofu_error",function(a){q("error",{file:p[a.id],message:a.message,code:0})})}});