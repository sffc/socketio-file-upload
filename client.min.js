/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2013 Shane Carr
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */
!function(e,t,n){"function"==typeof define&&define.amd?define(t,n):e[t]=n()}(this,"SocketIOFileUpload",function(){return function(e){"use strict";var t=this;if(!window.File||!window.FileReader)throw new Error("Socket.IO File Upload: Browser Not Supported");var n={},i=[],r=[];t.fileInputElementId="siofu_input",t.useText=!1,t.serializedOctets=!1,t.useBuffer=!0,t.chunkSize=102400;var o=function(e,n){var i=document.createEvent("Event");i.initEvent(e,!1,!1);for(var r in n)n.hasOwnProperty(r)&&(i[r]=n[r]);return t.dispatchEvent(i)},u=[],s=function(e,t,n,i){e.addEventListener(t,n,i),u.push(arguments)},a=function(e,t,n,i){e.removeEventListener&&e.removeEventListener(t,n,i)},f=function(){for(var e=u.length-1;e>=0;e--)a.apply(this,u[e]);u=[]},c=function(n){if(null!==t.maxFileSize&&n.size>t.maxFileSize)return void o("error",{file:n,message:"Attempt by client to upload file exceeding the maximum file size",code:1});var u=o("start",{file:n});if(u){var a,f=new FileReader,c=i.length,d=t.useText;i.push(n);var l=function(i,r,o){var u=!1;if(!d)try{var s=new Uint8Array(o);t.serializedOctets?o=s:t.useBuffer?o=s.buffer:(u=!0,o=h(s))}catch(a){return void e.emit("siofu_done",{id:c,interrupt:!0})}e.emit("siofu_progress",{id:c,size:n.size,start:i,end:r,content:o,base64:u})},m=function(){e.emit("siofu_done",{id:c})},v=function(t,n,i,r){n>t.size&&(n=t.size);var o=0,u=t.slice(o,o+n),a=function(){var f=new FileReader;f.onload=function(e){o+=n,u=t.slice(o,o+n),i.call(t,o-n,o,e.target.result),o<t.size?a():r.call(t)},d?f.readAsText(u):f.readAsArrayBuffer(u),s(f,"error",function(){e.emit("siofu_done",{id:c,interrupt:!0})}),s(f,"abort",function(){e.emit("siofu_done",{id:c,interrupt:!0})})};a()};s(f,"load",function(t){l(t.loaded),e.emit("siofu_done",{id:c}),o("load",{file:n,reader:f,name:a})}),s(f,"error",function(){e.emit("siofu_done",{id:c,interrupt:!0})}),s(f,"abort",function(){e.emit("siofu_done",{id:c,interrupt:!0})}),e.emit("siofu_start",{name:n.name,mtime:n.lastModifiedDate,meta:n.meta,size:n.size,encoding:d?"text":"octet",id:c});var p=function(e){0===f.readyState?(v(n,t.chunkSize,l,m),a=e):console.log("Warning: FileReader is currently reading data.")};r.push(p)}},d=function(e){for(var t=0;t<e.length;t++)c(e[t])},l=function(){var e=document.getElementById(t.fileInputElementId);return e||(e=document.createElement("input"),e.setAttribute("type","file"),e.setAttribute("id",t.fileInputElementId),e.style.display="none",document.body.appendChild(e)),e},m=function(){var e=document.getElementById(t.fileInputElementId);e&&e.parentNode.removeChild(e)},v=function(e){if(0!==e.length){for(var t=0;t<e.length;t++)e[t].meta={};var n=o("choose",{files:e});n&&d(e)}},p=function(e){var t=e.target.files||e.dataTransfer.files;e.preventDefault(),v(t)};this.submitFiles=function(e){e&&v(e)},this.listenOnSubmit=function(e,t){t.files&&s(e,"click",function(){v(t.files)},!1)},this.listenOnArraySubmit=function(e,t){for(var n in t)this.listenOnSubmit(e,t[n])},this.listenOnInput=function(e){e.files&&s(e,"change",p,!1)},this.listenOnDrop=function(e){s(e,"dragover",function(e){e.preventDefault()},!1),s(e,"drop",p)},this.prompt=function(){var e=l();s(e,"change",p,!1);var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(t)},this.destroy=function(){f(),m(),n={},i=[],r=[]},this.addEventListener=function(e,t){n[e]||(n[e]=[]),n[e].push(t)},this.removeEventListener=function(e,t){if(!n[e])return!1;for(var i=0;i<n[e].length;i++)if(n[e][i]===t)return n[e].splice(i,1),!0;return!1},this.dispatchEvent=function(e){var t=n[e.type];if(!t)return!0;for(var i=!0,r=0;r<t.length;r++){var o=t[r](e);o===!1&&(i=!1)}return i};var h=function(e){var t,n=e.buffer.byteLength,i="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(t=0;n>t;t+=3)i+=r[e[t]>>2],i+=r[(3&e[t])<<4|e[t+1]>>4],i+=r[(15&e[t+1])<<2|e[t+2]>>6],i+=r[63&e[t+2]];return n%3===2?i=i.substring(0,i.length-1)+"=":n%3===1&&(i=i.substring(0,i.length-2)+"=="),i};s(e,"siofu_ready",function(e){r[e.id](e.name)}),s(e,"siofu_complete",function(e){o("complete",{file:i[e.id],detail:e.detail,success:e.success})}),s(e,"siofu_error",function(e){o("error",{file:i[e.id],message:e.message,code:0})})}});