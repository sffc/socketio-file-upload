/* Socket IO File Upload Client-Side Library
 *   Copyright (C) 2013 Shane Carr
 *   Released under the X11 License
 * For more information, visit: https://github.com/vote539/socketio-file-upload
 */

window.SocketIOFileUpload=function(e){"use strict";var t=this;if(!window.File||!window.FileReader){throw new Error("Socket.IO File Upload: Browser Not Supported")}var n={},r=[],i=[];t.fileInputElementId="siofu_input";t.useText=false;t.serializedOctets=false;var s=function(e,n){var r=document.createEvent("Event");r.initEvent(e,false,false);for(var i in n){if(n.hasOwnProperty(i)){r[i]=n[i]}}return t.dispatchEvent(r)};var o=[];var u=function(e,t,n,r){e.addEventListener(t,n,r);o.push(arguments)};var a=function(e,t,n,r){if(e.removeEventListener){e.removeEventListener(t,n,r)}};var f=function(){for(var e=o.length-1;e>=0;e--){a.apply(this,o[e])}o=[]};var l=function(n){var o=s("start",{file:n});if(!o)return;var a=new FileReader,f=0,l=r.length,c=t.useText,h;r.push(n);var p=function(n){var r;if(c){r=a.result.slice(f,n)}else{try{var i=new Uint8Array(a.result,f,n);if(t.serializedOctets){r=i}else{r=m(i)}}catch(s){e.emit("siofu_done",{id:l,interrupt:true});return}}e.emit("siofu_progress",{id:l,start:f,end:n,content:r,base64:!t.serializedOctets});f=n};u(a,"progress",function(e){});u(a,"load",function(t){p(t.loaded);e.emit("siofu_done",{id:l});s("load",{file:n,reader:a,name:h})});u(a,"error",function(){e.emit("siofu_done",{id:l,interrupt:true})});u(a,"abort",function(){e.emit("siofu_done",{id:l,interrupt:true})});e.emit("siofu_start",{name:n.name,mtime:n.lastModifiedDate,encoding:c?"text":"octet",id:l});var d;if(c){d=function(e){a.readAsText(n);h=e}}else{d=function(e){a.readAsArrayBuffer(n);h=e}}i.push(d)};var c=function(e){for(var t=0;t<e.length;t++){l(e[t])}};var h=function(){var e=document.getElementById(t.fileInputElementId);if(!e){e=document.createElement("input");e.setAttribute("type","file");e.setAttribute("id",t.fileInputElementId);e.style.display="none";document.body.appendChild(e)}return e};var p=function(){var e=document.getElementById(t.fileInputElementId);if(e){e.parentNode.removeChild(e)}};var d=function(e){if(e.length>0){var t=s("choose",{files:e});if(t){c(e)}}};var v=function(e){var t=e.target.files||e.dataTransfer.files;e.preventDefault();d(t)};this.listenOnSubmit=function(e,t){if(!t.files)return;u(e,"click",function(){d(t.files)},false)};this.listenOnArraySubmit=function(e,t){for(var n in t){this.listenOnSubmit(e,t[n])}};this.listenOnInput=function(e){if(!e.files)return;u(e,"change",v,false)};this.listenOnDrop=function(e){u(e,"dragover",function(e){e.preventDefault()},false);u(e,"drop",v)};this.prompt=function(){var e=h();u(e,"change",v,false);var t=document.createEvent("MouseEvents");t.initMouseEvent("click",true,true,window,0,0,0,0,0,false,false,false,false,0,null);e.dispatchEvent(t)};this.destroy=function(){f();p()};this.addEventListener=function(e,t){if(!n[e])n[e]=[];n[e].push(t)};this.removeEventListener=function(e,t){if(!n[e])return false;for(var r=0;r<n[e].length;r++){if(n[e][r]===t){n[e].splice(r,1);return true}}return false};this.dispatchEvent=function(e){var t=n[e.type];if(!t)return true;var r=true;for(var i=0;i<t.length;i++){var s=t[i](e);if(s===false){r=false}}return r};var m=function(e){var t,n=e.buffer.byteLength,r="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(t=0;t<n;t+=3){r+=i[e[t]>>2];r+=i[(e[t]&3)<<4|e[t+1]>>4];r+=i[(e[t+1]&15)<<2|e[t+2]>>6];r+=i[e[t+2]&63]}if(n%3===2){r=r.substring(0,r.length-1)+"="}else if(n%3===1){r=r.substring(0,r.length-2)+"=="}return r};e.on("siofu_ready",function(e){i[e.id](e.name)});e.on("siofu_complete",function(e){s("complete",{file:r[e.id],detail:e.detail,success:e.success})})}